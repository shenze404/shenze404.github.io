<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¨å†Œ</title>
    <script>
        async function register() {
            console.log("ğŸ”¹ æ³¨å†ŒæŒ‰é’®è¢«ç‚¹å‡»äº†ï¼");

            var id = document.getElementById("id").value.trim();
            var avatar = document.getElementById("avatar").files[0];
            var password = document.getElementById("password").value.trim();

            if (!id || !avatar || !password) {
                alert("è¯·è¾“å…¥ IDã€é€‰æ‹©å¤´åƒå¹¶è®¾ç½®å¯†é’¥ï¼");
                console.log("âŒ ç¼ºå°‘è¾“å…¥ä¿¡æ¯ï¼Œæ³¨å†Œå¤±è´¥");
                return;
            }

            if (!/^\d{4}$/.test(password)) {
                alert("å¯†é’¥å¿…é¡»æ˜¯ 4 ä½æ•°å­—ï¼");
                console.log("âŒ å¯†é’¥æ ¼å¼é”™è¯¯");
                return;
            }

            try {
                var reader = new FileReader();
                reader.onload = async function(event) {
                    var avatarURL = event.target.result;

                    console.log("ğŸ”¹ è·å– `users.json` æ•°æ®...");
                    let response = await fetch('https://api.github.com/repos/shenze404/shenze404.github.io/contents/users.json', {
                        method: "GET",
                        headers: {
                            "Authorization": `token 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`,
                            "Accept": "application/vnd.github.v3+json"
                        }
                    });

                    if (!response.ok) {
                        throw new Error("æ— æ³•è·å– `users.json`ï¼Œå¯èƒ½æ˜¯è·¯å¾„é”™è¯¯æˆ– GitHub API é™åˆ¶ï¼");
                    }

                    let fileData = await response.json();
                    let users = JSON.parse(atob(fileData.content)); // Base64 è§£ç  JSON
                    console.log("âœ… `users.json` è·å–æˆåŠŸï¼å½“å‰ç”¨æˆ·åˆ—è¡¨ï¼š", users);

                    if (users.some(user => user.id === id)) {
                        alert("æ­¤ ID å·²è¢«æ³¨å†Œï¼Œè¯·ä½¿ç”¨å…¶ä»– IDï¼");
                        console.log("âŒ ID å·²å­˜åœ¨ï¼Œæ³¨å†Œå¤±è´¥");
                        return;
                    }

                    users.push({ id: id, avatar: avatarURL, password: password });
                    console.log("âœ… æ–°ç”¨æˆ·æ•°æ®å·²åˆ›å»ºï¼š", users);

                    await updateGitHub(users, fileData.sha);
                    
                    localStorage.setItem("statusMessage", "æ³¨å†ŒæˆåŠŸï¼");
                    localStorage.setItem("redirectTarget", "login.html");
                    localStorage.setItem("redirectDelay", 2000);
                    
                    console.log("âœ… æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬åˆ° `status.html`");
                    window.location.href = "status.html";
                };
                reader.readAsDataURL(avatar);
            } catch (error) {
                alert("å‘ç”Ÿé”™è¯¯ï¼š" + error.message);
                console.error("âŒ å‘ç”Ÿé”™è¯¯ï¼š", error);
            }
        }

        async function updateGitHub(data, sha) {
            let token = "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";
            let url = "https://api.github.com/repos/shenze404/shenze404.github.io/contents/users.json";

            try {
                console.log("ğŸ”¹ å¼€å§‹æ›´æ–° `users.json`...");
                let updatedContent = btoa(JSON.stringify(data, null, 2)); // Base64 ç¼–ç æ•°æ®

                let updateResponse = await fetch(url, {
                    method: "PUT",
                    headers: {
                        "Authorization": `token ${token}`,
                        "Accept": "application/vnd.github.v3+json",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        message: "æ›´æ–°ç”¨æˆ·æ•°æ®",
                        content: updatedContent,
                        sha: sha // éœ€è¦æä¾› `sha` ä»¥æ›´æ–°æ–‡ä»¶
                    })
                });

                if (!updateResponse.ok) {
                    throw new Error("æ— æ³•æ›´æ–° `users.json`ï¼Œå¯èƒ½æ˜¯ API é™åˆ¶æˆ– Token æƒé™ä¸è¶³ï¼");
                }

                console.log("âœ… `users.json` æ›´æ–°æˆåŠŸï¼");
            } catch (error) {
                alert("GitHub API é”™è¯¯ï¼š" + error.message);
                console.error("âŒ GitHub API é”™è¯¯ï¼š", error);
            }
        }
    </script>
</head>
<body>
    <h1>æ³¨å†Œ</h1>
    <label>ç”¨æˆ· IDï¼š</label>
    <input type="text" id="id" required><br><br>

    <label>ä¸Šä¼ å¤´åƒï¼š</label>
    <input type="file" id="avatar" accept="image/*" required><br><br>

    <label>è®¾ç½®å¯†é’¥ï¼ˆ4 ä½æ•°å­—ï¼‰ï¼š</label>
    <input type="password" id="password" maxlength="4" required placeholder="è¯·è®¾ç½®å››ä½æ•°å­—"><br><br>

    <button onclick="register()">æ³¨å†Œ</button>
    <button onclick="window.location.href='index.html'">è¿”å›ä¸»é¡µ</button>
</body>
</html>
